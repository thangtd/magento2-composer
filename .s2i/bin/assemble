#!/bin/bash -e
# The assemble script builds the application artifacts from a source and 
# places them into appropriate directories inside the image.

mkdir -p /tmp/preassemble

# Execute the default S2I script
source ${STI_SCRIPTS_PATH}/assemble

mkdir -p /tmp/postassemble

mkdir -p ./.composer/

export COMPOSER_HOME=./.composer/

cp ./auth.json ./.composer/

echo "Updating permissions for Magento folder ..."

cd ./

find var vendor pub/static pub/media app/etc -type f -exec chmod u+w {} \; && find var vendor pub/static pub/media app/etc -type d -exec chmod u+w {} \; && chmod u+x bin/magento

# Install App dependencies using Composer
./composer.phar install --no-interaction --no-ansi --optimize-autoloader $COMPOSER_ARGS

find var vendor pub/static pub/media app/etc -type f -exec chmod u+w {} \; && find var vendor pub/static pub/media app/etc -type d -exec chmod u+w {} \; && chmod u+x bin/magento

echo "Installing Magento ..."

php ./bin/magento list

php ./bin/magento setup:install --db-host=${DATABASE_SERVICE_NAME} --db-name=${DATABASE_NAME} --db-user=${DATABASE_USER} --db-password=${DATABASE_PASSWORD} --backend-frontname=admin --admin-user=infinity2067 --admin-password=84730*estinkill --admin-email=thangtd@gmail.com --admin-firstname=Henry --admin-lastname=Tran --base-url=http://m2-mysql-persistent-m2.192.168.1.8.nip.io/ --base-url-secure=https://m2-mysql-persistent-m2.192.168.1.8.nip.io/ --language=en_US --currency=USD --use-rewrites=1 --use-secure=0 --use-secure-admin=0 --cleanup-database

find var vendor pub/static pub/media app/etc -type f -exec chmod u+w {} \; && find var vendor pub/static pub/media app/etc -type d -exec chmod u+w {} \; && chmod u+x bin/magento

# You can write S2I scripts in any programming language, as long as the 
# scripts are executable inside the builder image.